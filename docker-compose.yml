services:
  db:
    image: mysql:5.7
    restart: always
    environment:
      MYSQL_DATABASE: mydb
      MYSQL_USER: user
      MYSQL_PASSWORD: CantSayPassword
      MYSQL_ROOT_PASSWORD: NoPasswordForIt
      MYSQL_HOST: 'db'
    ports:
      - "3306:3306"
    volumes:
      - my-db:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 10s
      retries: 5

  kafka:
    image: bitnami/kafka:3.6
    hostname: kafka
    restart: unless-stopped
    mem_limit: 1.5g
    ports:
      - "9092:9092"
    environment:
      # KRaft Mode Essentials
      KAFKA_ENABLE_KRAFT: "yes"
      KAFKA_CFG_NODE_ID: "1"
      KAFKA_CFG_PROCESS_ROLES: "controller,broker"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      
      # Network Configuration
      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
      
      # Performance
      KAFKA_HEAP_OPTS: "-Xmx800m -Xms400m"
      KAFKA_CFG_NUM_NETWORK_THREADS: "3"
      KAFKA_CFG_NUM_IO_THREADS: "8"
      
      # Health Check Tuning
      KAFKA_CFG_BACKGROUND_THREADS: "10"
    volumes:
      - kafka_data:/bitnami/kafka
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 --timeout 5000 | grep -q 'Version: 3.6'"]
      interval: 15s
      timeout: 20s
      retries: 10
      start_period: 60s

  webhook:
    build: ./webhook
    ports:
      - "8082:8080"
    depends_on:
      db:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
    volumes:
      - ./logs:/app/logs

  service:
    build: ./service
    ports:
      - "8081:8081"
    depends_on:
      db:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
    volumes:
      - ./logs:/app/logs

volumes:
  my-db:
  kafka_data:
  logs:
